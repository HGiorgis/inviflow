{% extends 'base.html' %} {% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-5">
  <div>
    <div class="d-flex align-items-center gap-3 mb-2">
      <span class="web3-badge">
        <i class="fas fa-chart-pie"></i>
        Portfolio Overview
      </span>
      <span class="web3-badge">
        <i class="fas fa-sync-alt"></i>
        Live Updates
      </span>
    </div>
    <h1 class="display-6 fw-bold mb-2">Dashboard</h1>
    <p class="text-secondary">
      Welcome back, {{ user.get_short_name|default:user.username }}
    </p>
  </div>
  <div class="text-end">
    <small class="text-secondary d-block">Last Updated</small>
    <span class="fw-semibold" id="current-datetime"></span>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-5">
  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <span class="stat-label">Total Portfolio Value</span>
          <div class="stat-value">
            ${{ total_portfolio_value|default:"0"|floatformat:2 }}
          </div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-briefcase"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="badge badge-primary">
          <i class="fas fa-arrow-up me-1"></i>
          +12.5% from last month
        </span>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <span class="stat-label">Recent Deposits</span>
          <div class="stat-value">{{ recent_deposits|length }}</div>
        </div>
        <div
          class="stat-icon"
          style="background: rgba(255, 59, 48, 0.1); color: var(--danger)"
        >
          <i class="fas fa-money-bill-wave"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="badge badge-warning">
          <i class="fas fa-clock me-1"></i>
          Last 30 days
        </span>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <span class="stat-label">Active Portfolios</span>
          <div class="stat-value">{{ portfolios|length }}</div>
        </div>
        <div
          class="stat-icon"
          style="background: rgba(0, 211, 143, 0.1); color: var(--success)"
        >
          <i class="fas fa-layer-group"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="badge badge-success">
          <i class="fas fa-check-circle me-1"></i>
          {{ portfolios|length }} Active
        </span>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Portfolios Section -->
  <div class="col-md-6">
    <div class="card h-100">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>
          <i class="fas fa-briefcase me-2" style="color: var(--primary)"></i>
          Your Portfolios
        </span>
        <a href="{% url 'portfolio:create' %}" class="btn btn-sm btn-primary">
          <i class="fas fa-plus me-1"></i>
          New
        </a>
      </div>
      <div class="card-body">
        {% if portfolios %}
        <div class="portfolio-list">
          {% for portfolio in portfolios %}
          <div
            class="portfolio-item d-flex justify-content-between align-items-center p-3 mb-2 rounded-3"
            style="background: var(--gray-1)"
          >
            <div>
              <h6 class="fw-semibold mb-1">{{ portfolio.name }}</h6>
              <small class="text-secondary"
                >{{ portfolio.holdings_count|default:0 }} holdings</small
              >
            </div>
            <div class="text-end">
              <div class="fw-bold amount">
                ${{ portfolio.total_value|floatformat:2 }}
              </div>
              <small
                class="text-{% if portfolio.daily_change > 0 %}success{% else %}danger{% endif %}"
              >
                <i
                  class="fas fa-arrow-{% if portfolio.daily_change > 0 %}up{% else %}down{% endif %} me-1"
                ></i>
                {{ portfolio.daily_change|default:"0"|floatformat:2 }}%
              </small>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <i
            class="fas fa-briefcase fa-3x mb-3"
            style="color: var(--gray-4)"
          ></i>
          <h6 class="fw-normal mb-2">No portfolios yet</h6>
          <p class="text-secondary small mb-3">
            Create your first portfolio to start investing
          </p>
          <a href="{% url 'portfolio:create' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-2"></i>
            Create Portfolio
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Recent Deposits Section -->
  <div class="col-md-6">
    <div class="card h-100">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>
          <i class="fas fa-clock me-2" style="color: var(--primary)"></i>
          Recent Deposits
        </span>
        <a
          href="{% url 'payments:deposit_list' %}"
          class="btn btn-sm btn-outline-primary"
        >
          View All
        </a>
      </div>
      <div class="card-body">
        {% if recent_deposits %}
        <div class="deposit-list">
          {% for deposit in recent_deposits %}
          <div
            class="deposit-item d-flex justify-content-between align-items-center p-3 mb-2 rounded-3"
            style="background: var(--gray-1)"
          >
            <div class="d-flex align-items-center gap-3">
              <div class="deposit-icon">
                <div
                  class="rounded-circle p-2"
                  style="
                    background: var(--primary-light);
                    width: 36px;
                    height: 36px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <i
                    class="fas fa-arrow-down"
                    style="color: var(--primary); font-size: 1rem"
                  ></i>
                </div>
              </div>
              <div>
                <h6 class="fw-semibold mb-1">
                  ${{ deposit.amount|floatformat:2 }} USDC
                </h6>
                <small class="text-secondary"
                  >{{ deposit.created_at|date:"M d, Y" }}</small
                >
              </div>
            </div>
            <div>
              {% if deposit.status == 'completed' %}
              <span class="badge badge-success">
                <i class="fas fa-check-circle me-1"></i> Completed
              </span>
              {% elif deposit.status == 'pending' %}
              <span class="badge badge-warning">
                <i class="fas fa-clock me-1"></i> Pending
              </span>
              {% else %}
              <span class="badge badge-danger">
                <i class="fas fa-times-circle me-1"></i> Failed
              </span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-clock fa-3x mb-3" style="color: var(--gray-4)"></i>
          <h6 class="fw-normal mb-2">No recent deposits</h6>
          <p class="text-secondary small mb-3">
            Make your first deposit to get started
          </p>
          <a
            href="{% url 'payments:deposit_create' %}"
            class="btn btn-primary btn-sm"
          >
            <i class="fas fa-plus me-2"></i>
            Make Deposit
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-bolt me-2" style="color: var(--primary)"></i>
        Quick Actions
      </div>
      <div class="card-body">
        <div class="d-flex gap-3 flex-wrap">
          <a
            href="{% url 'portfolio:create' %}"
            class="action-btn btn btn-outline-primary"
          >
            <i class="fas fa-plus-circle me-2"></i>
            New Portfolio
          </a>
          <a
            href="{% url 'payments:deposit_create' %}"
            class="action-btn btn btn-outline-success"
          >
            <i class="fas fa-coins me-2"></i>
            New Deposit
          </a>
          <a
            href="{% url 'core:stock_list' %}"
            class="action-btn btn btn-outline-secondary"
          >
            <i class="fas fa-search me-2"></i>
            Browse Stocks
          </a>
          <a
            href="{% url 'payments:invoice_list' %}"
            class="action-btn btn btn-outline-warning"
          >
            <i class="fas fa-file-invoice me-2"></i>
            View Invoices
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Performance Chart -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>
          <i class="fas fa-chart-line me-2" style="color: var(--primary)"></i>
          Portfolio Performance
        </span>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary active">1W</button>
          <button class="btn btn-outline-secondary">1M</button>
          <button class="btn btn-outline-secondary">3M</button>
          <button class="btn btn-outline-secondary">1Y</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="performanceChart" style="height: 300px"></canvas>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Update current datetime
  function updateDateTime() {
    const now = new Date();
    const options = {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    };
    document.getElementById("current-datetime").textContent =
      now.toLocaleDateString("en-US", options);
  }
  updateDateTime();
  setInterval(updateDateTime, 60000);

  // Performance Chart
  const ctx = document.getElementById("performanceChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      datasets: [
        {
          label: "Portfolio Value",
          data: [45000, 45800, 46200, 47000, 47500, 48200, 48800],
          borderColor: "var(--primary)",
          backgroundColor: "rgba(0, 82, 255, 0.05)",
          tension: 0.4,
          fill: true,
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: "var(--primary)",
          pointBorderColor: "white",
          pointBorderWidth: 2,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: "var(--primary)",
          pointHoverBorderColor: "white",
          pointHoverBorderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          mode: "index",
          intersect: false,
          backgroundColor: "white",
          titleColor: "var(--text-primary)",
          bodyColor: "var(--text-secondary)",
          borderColor: "var(--gray-3)",
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function (context) {
              return "Value: $" + context.raw.toLocaleString();
            },
          },
        },
      },
      scales: {
        y: {
          beginAtZero: false,
          grid: {
            color: "var(--gray-2)",
            drawBorder: false,
          },
          ticks: {
            callback: function (value) {
              return "$" + value.toLocaleString();
            },
          },
        },
        x: {
          grid: {
            display: false,
          },
        },
      },
    },
  });

  // Animate stats on hover
  document.querySelectorAll(".stat-card").forEach((card) => {
    card.addEventListener("mouseenter", function () {
      this.style.transform = "translateY(-5px)";
    });
    card.addEventListener("mouseleave", function () {
      this.style.transform = "translateY(0)";
    });
  });
</script>

<style>
  /* Additional dashboard styles */
  .portfolio-item,
  .deposit-item {
    transition: var(--transition);
    cursor: pointer;
  }

  .portfolio-item:hover,
  .deposit-item:hover {
    transform: translateX(5px);
    background: var(--gray-2) !important;
  }

  .action-btn {
    min-width: 160px;
    padding: 0.8rem 1.5rem;
    border-radius: 100px;
    font-weight: 500;
  }

  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn-group .btn {
    border: 1px solid var(--gray-3);
  }

  .btn-group .btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .stat-footer {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-3);
  }
</style>
{% endblock %} {% endblock %}
