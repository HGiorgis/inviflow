{% extends 'base.html' %} {% load static %} {% block title %}New Deposit -
InviFlow{% endblock %} {% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
  <div>
    <div class="d-flex align-items-center gap-3 mb-2">
      <span class="web3-badge">
        <i class="fas fa-coins"></i>
        New Transaction
      </span>
      <span class="web3-badge">
        <i class="fas fa-shield-alt"></i>
        Secure Payment
      </span>
    </div>
    <h1 class="display-6 fw-bold mb-2">Make a Deposit</h1>
    <p class="text-secondary">Add funds to your portfolio securely</p>
  </div>
  <a href="{% url 'payments:deposit_list' %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Back to Deposits
  </a>
</div>

<div class="row">
  <div class="col-md-8 mx-auto">
    <!-- Main Form Card -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-edit me-2" style="color: var(--primary)"></i>
        Deposit Details
      </div>
      <div class="card-body p-4">
        <form method="post" id="depositForm">
          {% csrf_token %}

          <!-- Portfolio Selection -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-briefcase me-2"
                style="color: var(--primary)"
              ></i>
              Select Portfolio
            </label>
            <select
              name="portfolio"
              class="form-select form-select-lg"
              required
            >
              <option value="" disabled selected>
                -- Choose a portfolio --
              </option>
              {% for portfolio in form.fields.portfolio.queryset %}
              <option
                value="{{ portfolio.id }}"
                data-balance="{{ portfolio.balance|default:'0' }}"
              >
                {{ portfolio.name }} {% if portfolio.balance %} (Balance: ${{
                portfolio.balance|floatformat:2 }}){% endif %}
              </option>
              {% endfor %}
            </select>
            <small class="text-secondary mt-2 d-block">
              <i class="fas fa-info-circle me-1"></i>
              Select the portfolio you want to deposit into
            </small>
          </div>

          <!-- Stock Selection (Optional) -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-chart-line me-2"
                style="color: var(--primary)"
              ></i>
              Allocate to Stock (Optional)
            </label>
            <select name="stock" class="form-select" id="stockSelect">
              <option value="" selected>-- Select a stock (optional) --</option>
              {% for stock in form.fields.stock.queryset %}
              <option
                value="{{ stock.id }}"
                data-price="{{ stock.current_price }}"
              >
                {{ stock.symbol }} - {{ stock.name }} (${{
                stock.current_price|floatformat:2 }})
              </option>
              {% endfor %}
            </select>
            <small class="text-secondary mt-2 d-block">
              <i class="fas fa-lightbulb me-1"></i>
              You can allocate this deposit to a specific stock
            </small>
          </div>

          <!-- Amount Input -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-dollar-sign me-2"
                style="color: var(--primary)"
              ></i>
              Deposit Amount
            </label>
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-transparent border-end-0">
                <i class="fas fa-dollar-sign" style="color: var(--primary)"></i>
              </span>
              <input
                type="number"
                name="amount"
                id="amount"
                step="0.01"
                min="10"
                class="form-control border-start-0"
                placeholder="0.00"
                required
              />
            </div>
            <div class="d-flex justify-content-between mt-2">
              <small class="text-secondary">Minimum: $10.00</small>
              <small class="text-secondary" id="conversionHint"></small>
            </div>
          </div>

          <!-- Quick Amount Selector -->
          <div class="mb-4">
            <label class="form-label small text-secondary">Quick Select</label>
            <div class="d-flex gap-2 flex-wrap">
              <button
                type="button"
                class="quick-amount btn btn-outline-primary btn-sm"
                onclick="setAmount(100)"
              >
                $100
              </button>
              <button
                type="button"
                class="quick-amount btn btn-outline-primary btn-sm"
                onclick="setAmount(500)"
              >
                $500
              </button>
              <button
                type="button"
                class="quick-amount btn btn-outline-primary btn-sm"
                onclick="setAmount(1000)"
              >
                $1,000
              </button>
              <button
                type="button"
                class="quick-amount btn btn-outline-primary btn-sm"
                onclick="setAmount(5000)"
              >
                $5,000
              </button>
              <button
                type="button"
                class="quick-amount btn btn-outline-primary btn-sm"
                onclick="setAmount(10000)"
              >
                $10,000
              </button>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-credit-card me-2"
                style="color: var(--primary)"
              ></i>
              Payment Method
            </label>
            <div class="row g-3">
              <div class="col-md-4">
                <div
                  class="payment-method-card"
                  onclick="selectPaymentMethod('bank_transfer')"
                >
                  <input
                    type="radio"
                    name="payment_method"
                    id="method_bank"
                    value="bank_transfer"
                    class="d-none"
                    required
                  />
                  <label for="method_bank" class="payment-method-label">
                    <div class="icon-circle mb-2">
                      <i class="fas fa-university"></i>
                    </div>
                    <span class="fw-semibold">Bank Transfer</span>
                    <small class="text-secondary">1-3 business days</small>
                  </label>
                </div>
              </div>

              <div class="col-md-4">
                <div
                  class="payment-method-card"
                  onclick="selectPaymentMethod('credit_card')"
                >
                  <input
                    type="radio"
                    name="payment_method"
                    id="method_card"
                    value="credit_card"
                    class="d-none"
                  />
                  <label for="method_card" class="payment-method-label">
                    <div class="icon-circle mb-2">
                      <i class="fas fa-credit-card"></i>
                    </div>
                    <span class="fw-semibold">Credit Card</span>
                    <small class="text-secondary">Instant</small>
                  </label>
                </div>
              </div>

              <div class="col-md-4">
                <div
                  class="payment-method-card"
                  onclick="selectPaymentMethod('crypto')"
                >
                  <input
                    type="radio"
                    name="payment_method"
                    id="method_crypto"
                    value="crypto"
                    class="d-none"
                  />
                  <label for="method_crypto" class="payment-method-label">
                    <div class="icon-circle mb-2">
                      <i class="fab fa-bitcoin"></i>
                    </div>
                    <span class="fw-semibold">Cryptocurrency</span>
                    <small class="text-secondary">USDC, ETH, BTC</small>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Card -->
          <div
            class="summary-card p-3 mb-4 rounded-3"
            style="background: var(--gray-1)"
          >
            <h6 class="fw-semibold mb-3">
              <i
                class="fas fa-calculator me-2"
                style="color: var(--primary)"
              ></i>
              Deposit Summary
            </h6>
            <div class="row g-2">
              <div class="col-6">
                <small class="text-secondary d-block">Amount</small>
                <span class="fw-semibold" id="summaryAmount">$0.00</span>
              </div>
              <div class="col-6">
                <small class="text-secondary d-block">Fee (0.5%)</small>
                <span class="fw-semibold" id="summaryFee">$0.00</span>
              </div>
              <div class="col-6">
                <small class="text-secondary d-block">Total</small>
                <span class="h5 mb-0" id="summaryTotal">$0.00</span>
              </div>
              <div class="col-6">
                <small class="text-secondary d-block">You'll receive</small>
                <span class="fw-semibold text-success" id="summaryReceive"
                  >$0.00</span
                >
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="d-flex gap-3">
            <button type="submit" class="btn btn-primary px-4 py-2 flex-grow-1">
              <i class="fas fa-check-circle me-2"></i>
              Confirm Deposit
            </button>
            <a
              href="{% url 'payments:deposit_list' %}"
              class="btn btn-outline-secondary px-4 py-2"
            >
              <i class="fas fa-times me-2"></i>
              Cancel
            </a>
          </div>

          <!-- Security Notice -->
          <div class="security-notice text-center mt-4">
            <small class="text-secondary">
              <i class="fas fa-lock me-1"></i>
              All transactions are encrypted and secure
            </small>
          </div>
        </form>
      </div>
    </div>

    <!-- Information Card -->
    <div class="card mt-4">
      <div class="card-header">
        <i class="fas fa-info-circle me-2" style="color: var(--primary)"></i>
        Deposit Information
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="text-center">
              <div class="info-icon mb-2">
                <i class="fas fa-bolt fa-2x" style="color: var(--primary)"></i>
              </div>
              <h6 class="fw-semibold mb-1">Instant Processing</h6>
              <small class="text-secondary">Card payments are instant</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center">
              <div class="info-icon mb-2">
                <i
                  class="fas fa-shield-alt fa-2x"
                  style="color: var(--primary)"
                ></i>
              </div>
              <h6 class="fw-semibold mb-1">Secure & Safe</h6>
              <small class="text-secondary">256-bit encryption</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center">
              <div class="info-icon mb-2">
                <i class="fas fa-clock fa-2x" style="color: var(--primary)"></i>
              </div>
              <h6 class="fw-semibold mb-1">24/7 Support</h6>
              <small class="text-secondary">Help anytime you need</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Set amount from quick select
  function setAmount(amount) {
    document.getElementById("amount").value = amount;
    updateSummary();

    // Highlight the selected button
    document.querySelectorAll(".quick-amount").forEach((btn) => {
      btn.classList.remove("active");
    });
    event.target.classList.add("active");
  }

  // Select payment method
  function selectPaymentMethod(method) {
    document.querySelectorAll(".payment-method-card").forEach((card) => {
      card.classList.remove("selected");
    });
    event.currentTarget.classList.add("selected");

    const radio = event.currentTarget.querySelector('input[type="radio"]');
    radio.checked = true;
  }

  // Update summary
  function updateSummary() {
    const amount = parseFloat(document.getElementById("amount").value) || 0;
    const fee = amount * 0.005; // 0.5% fee
    const total = amount + fee;

    document.getElementById("summaryAmount").textContent =
      "$" + amount.toFixed(2);
    document.getElementById("summaryFee").textContent = "$" + fee.toFixed(2);
    document.getElementById("summaryTotal").textContent =
      "$" + total.toFixed(2);
    document.getElementById("summaryReceive").textContent =
      "$" + amount.toFixed(2);

    // Show crypto conversion if selected
    const selectedMethod = document.querySelector(
      'input[name="payment_method"]:checked',
    );
    if (selectedMethod && selectedMethod.value === "crypto") {
      const ethAmount = amount / 3500; // Example ETH price
      document.getElementById("conversionHint").textContent =
        `â‰ˆ ${ethAmount.toFixed(4)} ETH`;
    } else {
      document.getElementById("conversionHint").textContent = "";
    }
  }

  // Form validation
  document
    .getElementById("depositForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const amount = parseFloat(document.getElementById("amount").value);
      const portfolio = document.querySelector(
        'select[name="portfolio"]',
      ).value;
      const paymentMethod = document.querySelector(
        'input[name="payment_method"]:checked',
      );

      if (!portfolio) {
        showToast("Please select a portfolio", "error");
        return;
      }

      if (!amount || amount < 10) {
        showToast("Minimum deposit amount is $10", "error");
        return;
      }

      if (!paymentMethod) {
        showToast("Please select a payment method", "error");
        return;
      }

      // Show confirmation
      showToast("Processing your deposit...", "info");

      // Submit form after confirmation
      setTimeout(() => {
        this.submit();
      }, 1500);
    });

  // Listen for amount changes
  document.getElementById("amount").addEventListener("input", updateSummary);
  document.querySelectorAll('input[name="payment_method"]').forEach((radio) => {
    radio.addEventListener("change", updateSummary);
  });

  // Stock selection hint
  document
    .getElementById("stockSelect")
    .addEventListener("change", function () {
      const selected = this.options[this.selectedIndex];
      if (selected.value) {
        const price = selected.dataset.price;
        showToast(`Selected stock price: $${price}`, "info");
      }
    });

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    updateSummary();

    // Select default payment method if none selected
    if (!document.querySelector('input[name="payment_method"]:checked')) {
      document.querySelector('input[name="payment_method"]').checked = true;
      document.querySelector(".payment-method-card").classList.add("selected");
    }
  });
</script>

<style>
  /* Deposit page specific styles */
  .payment-method-card {
    background: var(--white);
    border: 1px solid var(--gray-3);
    border-radius: var(--border-radius-md);
    padding: 1rem;
    cursor: pointer;
    transition: var(--transition);
    height: 100%;
  }

  .payment-method-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .payment-method-card.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    box-shadow: 0 0 0 2px var(--primary-light);
  }

  .payment-method-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    cursor: pointer;
    margin: 0;
  }

  .icon-circle {
    width: 48px;
    height: 48px;
    background: var(--primary-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    transition: var(--transition);
  }

  .payment-method-card:hover .icon-circle {
    background: var(--primary);
    color: white;
  }

  .payment-method-card.selected .icon-circle {
    background: var(--primary);
    color: white;
  }

  .quick-amount {
    min-width: 80px;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
  }

  .quick-amount.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .summary-card {
    border: 1px solid var(--gray-3);
    transition: var(--transition);
  }

  .summary-card:hover {
    border-color: var(--primary);
  }

  .info-icon {
    width: 48px;
    height: 48px;
    background: var(--primary-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
  }

  .form-select-lg,
  .input-group-lg {
    font-size: 1rem;
  }

  .input-group-text {
    padding: 0.6rem 1rem;
  }

  .security-notice {
    border-top: 1px solid var(--gray-3);
    padding-top: 1rem;
    margin-top: 1rem;
  }

  /* Loading state for submit button */
  .btn-primary.submitting {
    position: relative;
    color: transparent;
  }

  .btn-primary.submitting::after {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid white;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spinner 0.6s linear infinite;
  }

  @keyframes spinner {
    to {
      transform: rotate(360deg);
    }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .payment-method-card {
      margin-bottom: 1rem;
    }

    .quick-amount {
      min-width: 60px;
      font-size: 0.8rem;
    }
  }
</style>
{% endblock %}
