{% extends 'base.html' %} {% load static %} {% block title %}{{ portfolio.name
}} - InviFlow{% endblock %} {% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
  <div>
    <div class="d-flex align-items-center gap-3 mb-2">
      <span class="web3-badge">
        <i class="fas fa-briefcase"></i>
        Portfolio Details
      </span>
      <span class="web3-badge">
        <i class="fas fa-chart-line"></i>
        {{ holdings|length }} Holdings
      </span>
    </div>
    <h1 class="display-6 fw-bold mb-2">{{ portfolio.name }}</h1>
    <p class="text-secondary">
      {{ portfolio.description|default:"No description provided" }}
    </p>
  </div>
  <div class="d-flex gap-2">
    <a
      href="{% url 'portfolio:update' portfolio.pk %}"
      class="btn btn-outline-secondary"
    >
      <i class="fas fa-edit me-2"></i>
      Edit
    </a>
    <a href="{% url 'portfolio:list' %}" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left me-2"></i>
      Back to Portfolios
    </a>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <span class="stat-label">Total Value</span>
          <div class="stat-value">
            ${{ portfolio.total_value|floatformat:2 }}
          </div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
      </div>
      <div class="stat-footer mt-3 pt-3 border-top">
        <small class="text-secondary">
          <i class="fas fa-chart-line me-1"></i>
          +12.5% all time
        </small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <span class="stat-label">Total Holdings</span>
          <div class="stat-value">{{ holdings|length }}</div>
        </div>
        <div
          class="stat-icon"
          style="background: rgba(0, 211, 143, 0.1); color: var(--success)"
        >
          <i class="fas fa-chart-pie"></i>
        </div>
      </div>
      <div class="stat-footer mt-3 pt-3 border-top">
        <small class="text-secondary">
          <i class="fas fa-layer-group me-1"></i>
          {{ unique_sectors|default:"0" }} sectors
        </small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <span class="stat-label">Total Invested</span>
          <div class="stat-value">
            ${{ portfolio.total_invested|default:"0"|floatformat:2 }}
          </div>
        </div>
        <div
          class="stat-icon"
          style="background: rgba(255, 184, 0, 0.1); color: var(--warning)"
        >
          <i class="fas fa-history"></i>
        </div>
      </div>
      <div class="stat-footer mt-3 pt-3 border-top">
        <small class="text-secondary">
          <i class="fas fa-arrow-up me-1"></i>
          +${{ portfolio.total_profit|default:"0"|floatformat:2 }} profit
        </small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <span class="stat-label">Last Updated</span>
          <div class="stat-value">{{ portfolio.updated_at|date:"M d" }}</div>
        </div>
        <div
          class="stat-icon"
          style="background: rgba(108, 92, 231, 0.1); color: var(--secondary)"
        >
          <i class="fas fa-clock"></i>
        </div>
      </div>
      <div class="stat-footer mt-3 pt-3 border-top">
        <small class="text-secondary">
          <i class="fas fa-calendar me-1"></i>
          {{ portfolio.updated_at|timesince }} ago
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Performance Chart -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>
          <i class="fas fa-chart-line me-2" style="color: var(--primary)"></i>
          Portfolio Performance
        </span>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary">1W</button>
          <button class="btn btn-outline-secondary active">1M</button>
          <button class="btn btn-outline-secondary">3M</button>
          <button class="btn btn-outline-secondary">1Y</button>
          <button class="btn btn-outline-secondary">ALL</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="portfolioChart" style="height: 300px"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Holdings Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>
      <i class="fas fa-chart-pie me-2" style="color: var(--primary)"></i>
      Holdings
    </span>
    <button
      type="button"
      class="btn btn-primary btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#addHoldingModal"
    >
      <i class="fas fa-plus me-1"></i>
      Add Holding
    </button>
  </div>
  <div class="card-body p-0">
    {% if holdings %}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th>Stock</th>
            <th>Quantity</th>
            <th>Avg Buy</th>
            <th>Current</th>
            <th>Value</th>
            <th>P/L</th>
            <th>Return %</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for holding in holdings %}
          <tr class="holding-row">
            <td>
              <div class="d-flex align-items-center gap-2">
                <div
                  class="stock-icon rounded-circle bg-primary-light d-flex align-items-center justify-content-center"
                  style="width: 36px; height: 36px"
                >
                  <i
                    class="fas fa-chart-line"
                    style="color: var(--primary); font-size: 1rem"
                  ></i>
                </div>
                <div>
                  <span class="fw-semibold d-block"
                    >{{ holding.stock.symbol }}</span
                  >
                  <small class="text-secondary"
                    >{{ holding.stock.name|truncatechars:20 }}</small
                  >
                </div>
              </div>
            </td>
            <td>
              <span class="badge badge-secondary"
                >{{ holding.quantity|floatformat:4 }}</span
              >
            </td>
            <td>
              <span class="fw-semibold"
                >${{ holding.average_buy_price|floatformat:2 }}</span
              >
            </td>
            <td>
              <span class="fw-semibold"
                >${{ holding.stock.current_price|floatformat:2 }}</span
              >
            </td>
            <td>
              <span class="amount"
                >${{ holding.current_value|floatformat:2 }}</span
              >
            </td>
            <td>
              <span
                class="{% if holding.profit_loss > 0 %}text-success{% else %}text-danger{% endif %}"
              >
                <i
                  class="fas fa-arrow-{% if holding.profit_loss > 0 %}up{% else %}down{% endif %} me-1"
                ></i>
                ${{ holding.profit_loss|floatformat:2 }}
              </span>
            </td>
            <td>
              <span
                class="badge {% if holding.profit_loss_percent > 0 %}badge-success{% else %}badge-danger{% endif %}"
              >
                {{ holding.profit_loss_percent|floatformat:1 }}%
              </span>
            </td>
            <td>
              <div class="btn-group">
                <a
                  href="{% url 'portfolio:update_holding' holding.pk %}"
                  class="btn btn-sm btn-outline-primary"
                  title="Edit"
                >
                  <i class="fas fa-edit"></i>
                </a>
                <a
                  href="{% url 'portfolio:delete_holding' holding.pk %}"
                  class="btn btn-sm btn-outline-danger"
                  title="Delete"
                >
                  <i class="fas fa-trash"></i>
                </a>
                <button
                  class="btn btn-sm btn-outline-success"
                  onclick="showTradeModal('{{ holding.stock.symbol }}')"
                  title="Trade"
                >
                  <i class="fas fa-exchange-alt"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="bg-light">
          <tr>
            <td colspan="4" class="text-end fw-semibold">Total:</td>
            <td class="fw-bold amount">
              ${{ portfolio.total_value|floatformat:2 }}
            </td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="fas fa-chart-pie fa-4x mb-3" style="color: var(--gray-4)"></i>
      <h6 class="fw-normal mb-2">No holdings in this portfolio</h6>
      <p class="text-secondary small mb-3">
        Get started by adding your first stock
      </p>
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#addHoldingModal"
      >
        <i class="fas fa-plus me-2"></i>
        Add Holding
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Add Holding Modal -->
<div class="modal fade" id="addHoldingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus-circle me-2" style="color: var(--primary)"></i>
          Add Holding to {{ portfolio.name }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form
        method="post"
        action="{% url 'portfolio:add_holding' portfolio.pk %}"
        id="addHoldingForm"
      >
        {% csrf_token %}
        <div class="modal-body">
          <!-- Stock Selection -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-chart-line me-2"
                style="color: var(--primary)"
              ></i>
              Select Stock
            </label>
            <select
              name="stock_id"
              class="form-select"
              required
              id="stockSelect"
            >
              <option value="" disabled selected>-- Choose a stock --</option>
              {% for stock in stocks %}
              <option
                value="{{ stock.id }}"
                data-price="{{ stock.current_price }}"
              >
                {{ stock.symbol }} - {{ stock.name }} (${{
                stock.current_price|floatformat:2 }})
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Quantity -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-calculator me-2"
                style="color: var(--primary)"
              ></i>
              Quantity
            </label>
            <div class="input-group">
              <input
                type="number"
                name="quantity"
                id="quantity"
                step="0.01"
                min="0.01"
                class="form-control"
                placeholder="0.00"
                required
              />
              <span class="input-group-text">shares</span>
            </div>
          </div>

          <!-- Average Buy Price -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i
                class="fas fa-dollar-sign me-2"
                style="color: var(--primary)"
              ></i>
              Average Buy Price
            </label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input
                type="number"
                name="price"
                id="price"
                step="0.01"
                min="0.01"
                class="form-control"
                placeholder="0.00"
                required
              />
            </div>
            <small class="text-secondary" id="priceHint"></small>
          </div>

          <!-- Summary -->
          <div
            class="summary-card p-3 rounded-3 mt-3"
            style="background: var(--gray-1)"
          >
            <h6 class="fw-semibold mb-2">Transaction Summary</h6>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-secondary">Total Cost:</span>
              <span class="fw-semibold" id="totalCost">$0.00</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-secondary">Est. Value:</span>
              <span class="fw-semibold" id="estValue">$0.00</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            <i class="fas fa-times me-2"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-plus-circle me-2"></i>
            Add Holding
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize chart
    const ctx = document.getElementById("portfolioChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
        datasets: [
          {
            label: "Portfolio Value",
            data: [12000, 13500, 14200, 15800, 16500, 17200],
            borderColor: "var(--primary)",
            backgroundColor: "rgba(0, 82, 255, 0.05)",
            tension: 0.4,
            fill: true,
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
        },
      },
    });

    // Calculate totals in modal
    const stockSelect = document.getElementById("stockSelect");
    const quantityInput = document.getElementById("quantity");
    const priceInput = document.getElementById("price");
    const totalCostSpan = document.getElementById("totalCost");
    const estValueSpan = document.getElementById("estValue");
    const priceHint = document.getElementById("priceHint");

    function updateSummary() {
      const quantity = parseFloat(quantityInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const total = quantity * price;

      totalCostSpan.textContent = "$" + total.toFixed(2);

      if (stockSelect.selectedIndex > 0) {
        const selectedOption = stockSelect.options[stockSelect.selectedIndex];
        const currentPrice = parseFloat(selectedOption.dataset.price) || 0;
        const estValue = quantity * currentPrice;
        estValueSpan.textContent = "$" + estValue.toFixed(2);
      }
    }

    quantityInput.addEventListener("input", updateSummary);
    priceInput.addEventListener("input", updateSummary);

    stockSelect.addEventListener("change", function () {
      if (this.selectedIndex > 0) {
        const selectedOption = this.options[this.selectedIndex];
        const currentPrice = parseFloat(selectedOption.dataset.price) || 0;
        priceHint.textContent = `Current market price: $${currentPrice.toFixed(2)}`;
        priceInput.placeholder = currentPrice.toFixed(2);
      }
      updateSummary();
    });
  });

  function showTradeModal(symbol) {
    showToast(`Trading ${symbol} coming soon`, "info");
  }
</script>

<style>
  .holding-row {
    transition: var(--transition);
  }

  .holding-row:hover {
    background: var(--gray-1) !important;
  }

  .stock-icon {
    transition: var(--transition);
  }

  .holding-row:hover .stock-icon {
    background: var(--primary) !important;
  }

  .holding-row:hover .stock-icon i {
    color: white !important;
  }

  .amount {
    color: var(--primary);
    font-weight: 600;
  }

  .summary-card {
    border: 1px solid var(--gray-3);
  }

  .modal-content {
    border: none;
    border-radius: var(--border-radius-md);
  }

  .modal-header {
    border-bottom: 1px solid var(--gray-3);
    padding: 1.25rem 1.5rem;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    border-top: 1px solid var(--gray-3);
    padding: 1.25rem 1.5rem;
  }
</style>
{% endblock %}
